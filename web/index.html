<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Orders Demo</title>

  <script>
    /* ============================================================
       1) Load config.json (contains API URL + Cognito settings)
    ============================================================ */
    let config = null;
    let tokens = null;

    async function loadConfig() {
      const r = await fetch("config.json", { cache: "no-store" });
      config = await r.json();
    }

    /* ============================================================
       2) Redirect to Cognito Hosted Login page
    ============================================================ */
    function redirectToLogin() {
      const redirectUri = encodeURIComponent(window.location.origin);

      const loginUrl =
        `${config.cognitoDomain}/login?` +
        `client_id=${config.userPoolClientId}` +
        `&response_type=code` +
        `&scope=openid+email+profile` +
        `&redirect_uri=${redirectUri}`;

      window.location.href = loginUrl;
    }

    /* ============================================================
       3) Exchange authorization code ?code= for tokens
    ============================================================ */
    async function exchangeAuthCodeForTokens(code) {
      const redirectUri = window.location.origin;

      const body =
        `grant_type=authorization_code` +
        `&client_id=${config.userPoolClientId}` +
        `&code=${code}` +
        `&redirect_uri=${encodeURIComponent(redirectUri)}`;

      const resp = await fetch(`${config.cognitoDomain}/oauth2/token`, {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body
      });

      if (!resp.ok) {
        console.error("Token exchange failed", await resp.text());
        redirectToLogin();
        return;
      }

      tokens = await resp.json();
      localStorage.setItem("cognito_tokens", JSON.stringify(tokens));

      // Remove ?code= from URL
      window.history.replaceState({}, "", window.location.origin);
    }

    /* ============================================================
       4) Ensure user is authenticated before loading app
    ============================================================ */
    async function ensureAuthenticated() {
      await loadConfig();

      // Already logged in?
      const saved = localStorage.getItem("cognito_tokens");
      if (saved) {
        tokens = JSON.parse(saved);
        return;
      }

      // Do we have a ?code from Cognito redirect?
      const params = new URLSearchParams(window.location.search);
      if (params.has("code")) {
        await exchangeAuthCodeForTokens(params.get("code"));
        return;
      }

      // No login â†’ redirect
      redirectToLogin();
    }

    // Authenticate BEFORE page renders
    ensureAuthenticated();
  </script>
</head>

<body>

  <h1>Orders Demo</h1>

  <!-- ============================================================
       CREATE ORDER
  ============================================================ -->
  <h2>Create Order</h2>
  <form id="createForm">
    <div>
      <label>Name: <input name="name" required></label>
    </div>
    <div>
      <label>Product: <input name="product" required></label>
    </div>
    <div>
      <label>Email: <input name="email"></label>
    </div>
    <button type="submit" id="createBtn">Create</button>
  </form>
  <p id="createMsg"></p>

  <!-- ============================================================
       LIST ORDERS
  ============================================================ -->
  <h2>List Orders</h2>
  <button id="listBtn">List Orders</button>
  <div id="listResults"></div>

  <!-- ============================================================
       GET ORDER BY ID
  ============================================================ -->
  <h2>Get Order by ID</h2>
  <form id="getOneForm">
    <div>
      <label>Order ID: <input name="orderId" required></label>
    </div>
    <button type="submit" id="getOneBtn">Get Order</button>
  </form>
  <div id="oneResult"></div>

  <!-- ============================================================
       MAIN SCRIPT
  ============================================================ -->
  <script>
    let API = null;

    // Load API URL from config.json
    async function loadConfigFile() {
      const r = await fetch("config.json", { cache: "no-store" });
      const cfg = await r.json();
      API = (cfg.apiBase || "").trim();
    }

    function extractValue(field) {
      return field ? (field.S || field.N || "") : "";
    }

    function renderOrderTable(items) {
      if (!Array.isArray(items) || items.length === 0) {
        return "<p>(no orders yet)</p>";
      }

      let html = `
        <table border="1" cellpadding="4" cellspacing="0">
          <tr><th>Order ID</th><th>Name</th><th>Product</th><th>Email</th><th>Created At</th></tr>
      `;

      for (const o of items) {
        html += `
          <tr>
            <td>${extractValue(o.orderId)}</td>
            <td>${extractValue(o.name)}</td>
            <td>${extractValue(o.product)}</td>
            <td>${extractValue(o.email)}</td>
            <td>${extractValue(o.createdAt)}</td>
          </tr>`;
      }

      html += "</table>";
      return html;
    }

    function renderSingleOrder(item) {
      if (!item) return "<p>(not found)</p>";

      const fields = ["orderId", "name", "product", "email", "createdAt", "ttl"];
      let html = `
        <table border="1" cellpadding="4" cellspacing="0">
          <tr><th>Field</th><th>Value</th></tr>
      `;

      for (const k of fields) {
        if (item[k]) {
          html += `<tr><td>${k}</td><td>${extractValue(item[k])}</td></tr>`;
        }
      }
      html += "</table>";
      return html;
    }

    /* ============================================================
       API CALLS (INLINE AUTH HEADER)
    ============================================================ */

    async function listOrders() {
      listResults.textContent = "Loading...";
      const idToken = JSON.parse(localStorage.getItem("cognito_tokens") || "{}").id_token;

      try {
        const r = await fetch(API, {
          headers: { "Authorization": "Bearer " + idToken }
        });
        if (!r.ok) throw new Error("HTTP " + r.status);
        const j = await r.json();
        listResults.innerHTML = renderOrderTable(j.orders || []);
      } catch (e) {
        listResults.textContent = "Error listing orders: " + e;
      }
    }

    async function getOrderById(orderId) {
      oneResult.textContent = "Loading...";
      const idToken = JSON.parse(localStorage.getItem("cognito_tokens") || "{}").id_token;

      try {
        const r = await fetch(API + "/" + encodeURIComponent(orderId), {
          headers: { "Authorization": "Bearer " + idToken }
        });

        if (r.status === 404) {
          oneResult.innerHTML = renderSingleOrder(null);
          return;
        }
        if (!r.ok) throw new Error("HTTP " + r.status);

        const j = await r.json();
        oneResult.innerHTML = renderSingleOrder(j.order || null);
      } catch (e) {
        oneResult.textContent = "Error fetching order: " + e;
      }
    }

    document.getElementById("createForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      if (!API) {
        createMsg.textContent = "API not ready yet.";
        return;
      }

      const idToken = JSON.parse(localStorage.getItem("cognito_tokens") || "{}").id_token;

      const data = Object.fromEntries(new FormData(e.target).entries());
      createMsg.textContent = "";
      createBtn.disabled = true;

      try {
        const r = await fetch(API, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Authorization": "Bearer " + idToken
          },
          body: JSON.stringify(data),
        });

        let orderId = "";
        try {
          const text = await r.text();
          const parsed = JSON.parse(text || "{}");
          orderId = parsed.orderId || "";
        } catch {}

        if (!r.ok) {
          createMsg.textContent = "Create failed.";
        } else {
          createMsg.textContent =
            "Order created successfully" +
            (orderId ? " (id: " + orderId + ")" : "");
          e.target.reset();
        }
      } catch (err) {
        createMsg.textContent = "Create failed: " + err;
      } finally {
        createBtn.disabled = false;
      }
    });

    document.getElementById("listBtn").addEventListener("click", listOrders);

    document.getElementById("getOneForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      if (!API) {
        oneResult.textContent = "API not ready yet.";
        return;
      }
      const orderId = new FormData(e.target).get("orderId");
      await getOrderById(orderId);
    });

    // Load config.json at startup
    loadConfigFile();
  </script>
</body>
</html>
